<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Manage Questions</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    #question-list li {
      padding: 0.5rem;
      border: 1px solid #ccc;
      margin-bottom: 0.5rem;
      border-radius: 4px;
    }
    small {
      display: block;
      color: #666;
      margin-top: 0.25rem;
    }
  </style>
</head>
<body>
  <nav class="container-fluid">
    <ul><li><strong>Admin</strong></li></ul>
    <ul>
      <li><a href="/admin/questions">Questions</a></li>
      <li><a href="/admin/agreement">Agreement</a></li>
      <li><a href="/admin/submissions">Submissions</a></li>
    </ul>
  </nav>

  <main class="container">
    <h2>Manage Questions</h2>
    <form id="question-form">
      <input type="text" id="label" placeholder="Label" required />
      <input type="text" id="name" placeholder="Field name (no spaces)" required />
      <select id="type" required>
        <option value="">-- Type --</option>
        <option value="text">Short Text</option>
        <option value="textarea">Paragraph</option>
        <option value="select">Dropdown</option>
        <option value="checkbox">Checkbox</option>
        <option value="file">File Upload</option>
      </select>
      <input type="text" id="options" placeholder="Options (comma-separated)" />
      <textarea id="help" placeholder="Helpful text (HTML allowed)"></textarea>
      <input type="text" id="section" placeholder="Section (e.g. Web Developer)" />
      <input type="text" id="group" placeholder="Group (optional - e.g. kit-custom)" />
      <input type="text" id="groupTrigger" placeholder="Group Trigger (e.g. kit-custom:Custom)" />
      <label><input type="checkbox" id="required" /> Required</label>
      <input type="hidden" id="edit-index" />
      <button type="submit">Save Question</button>
    </form>

    <hr />
    <h3>Current Questions</h3>
    <ul id="question-list"></ul>
    <button id="save-all">Save All & Reorder</button>
  </main>

  <script>
    let currentQuestions = [];

    async function loadQuestions() {
      const res = await fetch("/api/questions");
      const json = await res.json();
      currentQuestions = json.questions || [];
      renderList();
    }

    function renderList() {
      const list = document.getElementById("question-list");
      list.innerHTML = "";
      currentQuestions.forEach((q, i) => {
        const li = document.createElement("li");
        li.dataset.index = i;
        li.innerHTML = `
          <strong>${q.label}</strong> (${q.type})
          ${q.required ? "<em> - required</em>" : ""}
          ${q.section ? `<br><small><strong>Section:</strong> ${q.section}</small>` : ""}
          ${q.help ? `<small><strong>Help:</strong> ${q.help}</small>` : ""}
          ${q.group ? `<small><strong>Group:</strong> ${q.group}</small>` : ""}
          ${q.groupTrigger ? `<small><strong>Group Trigger:</strong> ${q.groupTrigger}</small>` : ""}
          <br>
          <button onclick="editQuestion(${i})">‚úèÔ∏è Edit</button>
          <button onclick="deleteQuestion(${i})">üóëÔ∏è Delete</button>
        `;
        list.appendChild(li);
      });
    }

    function editQuestion(i) {
      const q = currentQuestions[i];
      document.getElementById("label").value = q.label || "";
      document.getElementById("name").value = q.name || "";
      document.getElementById("type").value = q.type || "";
      document.getElementById("options").value = q.options || "";
      document.getElementById("help").value = q.help || "";
      document.getElementById("section").value = q.section || "";
      document.getElementById("group").value = q.group || "";
      document.getElementById("groupTrigger").value = q.groupTrigger || "";
      document.getElementById("required").checked = q.required || false;
      document.getElementById("edit-index").value = i;
    }

    function deleteQuestion(i) {
      if (confirm("Delete this question?")) {
        currentQuestions.splice(i, 1);
        renderList();
      }
    }

    document.getElementById("question-form").addEventListener("submit", (e) => {
      e.preventDefault();
      const q = {
        label: document.getElementById("label").value,
        name: document.getElementById("name").value,
        type: document.getElementById("type").value,
        options: document.getElementById("options").value,
        help: document.getElementById("help").value,
        required: document.getElementById("required").checked,
        section: document.getElementById("section").value,
        group: document.getElementById("group").value,
        groupTrigger: document.getElementById("groupTrigger").value,
      };

      const editIndex = document.getElementById("edit-index").value;
      if (editIndex !== "") {
        currentQuestions[editIndex] = q;
        document.getElementById("edit-index").value = "";
      } else {
        currentQuestions.push(q);
      }

      e.target.reset();
      renderList();
    });

    document.getElementById("save-all").addEventListener("click", async () => {
      const reordered = Array.from(document.querySelectorAll("#question-list li")).map(
        (li) => currentQuestions[li.dataset.index]
      );

      const res = await fetch("/api/questions", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ questions: reordered }),
      });

      if (res.ok) {
        alert("Saved!");
      } else {
        alert("Error saving questions.");
      }
    });

    new Sortable(document.getElementById("question-list"), { animation: 150 });

    loadQuestions();
  </script>
</body>
</html>
