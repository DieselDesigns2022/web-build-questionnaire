<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Questionnaire</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css" />
  <style>
    .hidden { display: none; }
    .section-header {
      margin-top: 2rem;
      border-bottom: 2px solid #ccc;
      padding-bottom: 0.25rem;
    }
    form > div:not(:last-child) {
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <main class="container">
    <h2>Client Questionnaire</h2>
    <form id="questionnaire" method="POST" action="/submit" enctype="multipart/form-data"></form>
  </main>

  <script>
    async function loadQuestions() {
      const res = await fetch("/api/questions");
      const json = await res.json();
      const questions = json.questions || [];
      const form = document.getElementById("questionnaire");

      // Group triggers
      const triggers = {};
      questions.forEach((q) => {
        if (q.groupTrigger) {
          q.groupTrigger.split(",").forEach(trigger => {
            const [group, value] = trigger.split(":").map(x => x.trim());
            if (!triggers[q.name]) triggers[q.name] = [];
            triggers[q.name].push({ group, value });
          });
        }
      });

      const visibleGroups = new Set();
      const sections = {};

      questions.forEach((q) => {
        if (q.section) {
          if (!sections[q.section]) {
            const h = document.createElement("h3");
            h.className = "section-header";
            h.innerText = q.section;
            form.appendChild(h);
            sections[q.section] = true;
          }
        }

        const wrapper = document.createElement("div");
        wrapper.dataset.group = q.group || "";
        if (q.group) wrapper.classList.add("hidden");

        const label = document.createElement("label");
        label.innerHTML = `${q.label}${q.required ? " *" : ""}`;

        if (q.help) {
          const small = document.createElement("small");
          small.innerHTML = q.help;
          label.appendChild(small);
        }

        let field;
        switch (q.type) {
          case "text":
            field = document.createElement("input");
            field.type = "text";
            break;
          case "textarea":
            field = document.createElement("textarea");
            break;
          case "select":
            field = document.createElement("select");
            q.options?.split(",").forEach(opt => {
              const option = document.createElement("option");
              option.value = opt.trim();
              option.innerText = opt.trim();
              field.appendChild(option);
            });
            break;
          case "checkbox":
            field = document.createElement("input");
            field.type = "checkbox";
            break;
          case "file":
            field = document.createElement("input");
            field.type = "file";
            break;
          default:
            field = document.createElement("input");
            field.type = "text";
        }

        field.name = q.name;
        field.required = q.required || false;

        // Add event for group trigger
        if (triggers[q.name]) {
          field.addEventListener("change", (e) => {
            const val = e.target.value;
            document.querySelectorAll("[data-group]").forEach(el => {
              const group = el.dataset.group;
              const match = triggers[q.name].some(t => t.group === group && t.value === val);
              if (match) {
                el.classList.remove("hidden");
              } else {
                el.classList.add("hidden");
              }
            });
          });
        }

        label.appendChild(field);
        wrapper.appendChild(label);
        form.appendChild(wrapper);
      });

      const submit = document.createElement("button");
      submit.type = "submit";
      submit.innerText = "Submit";
      form.appendChild(submit);
    }

    loadQuestions();
  </script>
</body>
</html>
