<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Questionnaire</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css" />
  <style>
    #agreement-box {
      border: 1px solid #ccc;
      height: 150px;
      overflow-y: scroll;
      padding: 1rem;
      background: #f8f8f8;
      margin-bottom: 1rem;
    }
    #submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <main class="container">
    <h2>Customer Questionnaire</h2>
    <form id="question-form" method="POST" action="/submit" enctype="multipart/form-data">
      <div id="question-area"></div>

      <h4>Order Agreement</h4>
      <div id="agreement-box"></div>
      <label>
        <input type="checkbox" id="agree-checkbox" disabled />
        I have read and agree to the terms above
      </label>

      <button type="submit" id="submit-btn" disabled>Submit</button>
    </form>
  </main>

  <script>
    async function loadQuestions() {
      const res = await fetch("/api/questions");
      const questions = await res.json();
      const container = document.getElementById("question-area");

      questions.forEach(q => {
        const wrapper = document.createElement("div");

        const label = document.createElement("label");
        label.textContent = q.label;
        wrapper.appendChild(label);

        if (q.help) {
          const help = document.createElement("small");
          help.textContent = q.help;
          wrapper.appendChild(help);
        }

        let field;
        if (q.type === "textarea") {
          field = document.createElement("textarea");
        } else if (q.type === "select") {
          field = document.createElement("select");
          (q.options || "").split(",").forEach(opt => {
            const option = document.createElement("option");
            option.value = opt.trim();
            option.textContent = opt.trim();
            field.appendChild(option);
          });
        } else if (q.type === "checkbox") {
          field = document.createElement("input");
          field.type = "checkbox";
        } else if (q.type === "file") {
          field = document.createElement("input");
          field.type = "file";
        } else {
          field = document.createElement("input");
          field.type = "text";
        }

        field.name = q.name;
        if (q.required) field.required = true;
        wrapper.appendChild(field);
        container.appendChild(wrapper);
      });
    }

    async function loadAgreement() {
      const res = await fetch("/agreement.txt");
      const text = await res.text();
      document.getElementById("agreement-box").textContent = text;
    }

    function setupAgreementCheckbox() {
      const agreement = document.getElementById("agreement-box");
      const checkbox = document.getElementById("agree-checkbox");
      const submitBtn = document.getElementById("submit-btn");

      agreement.addEventListener("scroll", () => {
        if (
          agreement.scrollTop + agreement.clientHeight >=
          agreement.scrollHeight
        ) {
          checkbox.disabled = false;
        }
      });

      checkbox.addEventListener("change", () => {
        submitBtn.disabled = !checkbox.checked;
      });
    }

    loadQuestions();
    loadAgreement();
    setupAgreementCheckbox();
  </script>
</body>
</html>
